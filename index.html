<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t - sosordi03</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, setDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.db = db; // expos√© pour les fonctions non-module
</script>

<script>
// ===============================
// UI helpers
// ===============================
function formatTel(){
  const v = tel.value.replace(/\D/g,"").slice(0,10);
  tel.value = v.replace(/(..)(?=.)/g,"$1-");
}

// Fermer la liste si on clique ailleurs / si champ vide / ESC
document.addEventListener("click", e=>{
  if(!e.target.closest("#search") && !e.target.closest("#suggest")) suggest.style.display = "none";
});
document.addEventListener("keydown", e=>{
  if(e.key === "Escape") suggest.style.display = "none";
});

// ===============================
// RECHERCHE CLIENT (nom + t√©l√©phone)
// ===============================
// On charge une fois tous les clients, puis on filtre c√¥t√© client
let _clientsCache = null;  // [{nom, tel}, ...]
async function _chargerClientsSiBesoin(){
  if(_clientsCache) return _clientsCache;
  const snap = await getDocs(collection(window.db, "clients"));
  _clientsCache = [];
  snap.forEach(d=>{
    const c = d.data() || {};
    if(c.nom && c.tel) _clientsCache.push({nom:String(c.nom), tel:String(c.tel)});
  });
  return _clientsCache;
}

async function rechercherClient(){
  const saisie = search.value.trim();
  const inputNom = saisie.toUpperCase();       // recherche par NOM en majuscules
  const inputTel = saisie.replace(/\D/g,"");   // recherche par NUM√âRO (uniquement chiffres)

  suggest.innerHTML = "";
  if(inputNom.length < 2 && inputTel.length < 2){ suggest.style.display="none"; return; }

  const data = await _chargerClientsSiBesoin();
  const results = data.filter(c=>{
    const nomU = c.nom.toUpperCase();
    const telDigits = c.tel.replace(/\D/g,"");
    return (inputNom.length>=2 && nomU.includes(inputNom)) ||
           (inputTel.length>=2 && telDigits.includes(inputTel));
  });

  if(results.length === 0){
    suggest.innerHTML = `
      <div class="sug" style="color:#b00;">Aucun r√©sultat</div>
      <button class="primary small-btn" style="width:100%;margin:6px 0;" onclick="ajouterNouveauClient()">‚ûï Ajouter ce client</button>`;
  } else {
    results.forEach(c=>{
      // S√©curise l'injection (remplace guillemets)
      const n = c.nom.replace(/"/g,"&quot;");
      const t = c.tel.replace(/"/g,"&quot;");
      suggest.innerHTML += `<div class="sug" onclick='remplirClient("${n}","${t}")'>${c.nom} ‚Äî ${c.tel}</div>`;
    });
  }
  suggest.style.display = "block";
}
window.rechercherClient = rechercherClient;

function remplirClient(n,t){
  nom.value = n;
  tel.value = t;
  suggest.style.display = "none";
}

// ===============================
// AJOUT CLIENT si non trouv√©
// ===============================
async function ajouterNouveauClient(){
  if(!search.value.trim()) return alert("Nom vide.");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant.");

  // Ajout c√¥t√© Firestore
  const { setDoc, doc, collection } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  await setDoc(doc(collection(window.db,"clients")),{
    nom: search.value.trim().toUpperCase(),
    tel: tel.value.trim()
  });

  // Mets √† jour le cache local pour que ce client apparaisse lors d'une prochaine recherche
  if(_clientsCache){
    _clientsCache.push({ nom: search.value.trim().toUpperCase(), tel: tel.value.trim() });
  }

  nom.value = search.value.toUpperCase();
  suggest.style.display="none";
  alert("‚úÖ Client ajout√© !");
}
window.ajouterNouveauClient = ajouterNouveauClient;

// ===============================
// Appareils (multi)
// ===============================
let appareils = [];
function ajouterAppareil(){
  appareils.push({ type:type.value, marque:marque.value, modele:modele.value });
  afficherAppareils(); modele.value="";
}
function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:6px;border-bottom:1px solid #ccc;">
    ${a.type} ‚Äî ${a.marque} ${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}
function supprimerAppareil(i){ appareils.splice(i,1); afficherAppareils(); }
window.ajouterAppareil = ajouterAppareil;

// ===============================
// Sauvegarde (afficher d√©tails si Oui)
// ===============================
document.addEventListener("DOMContentLoaded", ()=>{
  document.querySelectorAll('input[name="sauv"]').forEach(r=>{
    r.onchange = ()=>{ optionsSauvegarde.style.display = (r.value==="Oui")?"block":"none"; };
  });
});

// ===============================
// Travaux (accord√©on)
// ===============================
function toggleAccordion(el){ el.parentNode.classList.toggle("open"); }
window.toggleAccordion = toggleAccordion;

// ===============================
// Cr√©ation fiche (inchang√© hors ajout complet des champs)
// ===============================
async function creer(){
  if(!nom.value.trim()) return alert("Nom manquant");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant");
  if(appareils.length === 0) return alert("Ajoute au moins un appareil");

  const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");

  const sauvegardeChoix = document.querySelector('input[name="sauv"]:checked')?.value || "Non";
  const sauvItems = [...document.querySelectorAll('input[name="sauv-item"]:checked')].map(c => c.value);
  const travauxSelectionnes = [...document.querySelectorAll('.trav:checked')].map(c => c.value);

  await addDoc(collection(window.db,"fiches"),{
    nom: nom.value,
    tel: tel.value,
    appareils: appareils,
    probleme: prob.value,
    sauvegarde: sauvegardeChoix,
    sauvegardeItems: sauvItems,
    travaux: travauxSelectionnes,
    motdepasse: mdp.value.trim() || "",
    date: new Date().toISOString()
  });

  location.href="historique.html";
}
window.creer = creer;

// ===============================
// Marques par type (inchang√©)
// ===============================
const marquesParType = {
  "Ordinateur Portable": ["Acer","Asus","HP","Lenovo","Dell","MSI","Apple","Samsung","Toshiba","Autre"],
  "Ordinateur Fixe": ["Assembler","Acer","Asus","HP","Dell","Lenovo","Autre"],
  "Tablette": ["Apple","Samsung","Lenovo","Huawei","Microsoft Surface","Autre"],
  "Disque dur externe": ["Seagate","Western Digital","Toshiba","Samsung","LaCie","Autre"],
  "√âcran": ["Samsung","LG","AOC","Iiyama","Philips","Dell","Asus","Autre"],
  "Imprimante": ["HP","Canon","Epson","Brother","Lexmark","Samsung","Autre"],
  "Autre": ["Autre"]
};
function majMarques(){
  marque.innerHTML = "";
  (marquesParType[type.value]||["Autre"]).forEach(m=> marque.innerHTML += `<option>${m}</option>`);
}
document.addEventListener("DOMContentLoaded", majMarques);
</script>

<!-- petit style local pour le bloc carte -->
<style>.card-block{background:#f6f9fc;padding:12px;border-radius:8px;margin-top:12px;border:1px solid #d8e0e8;}</style>
</head>
<body>

<div class="container">
  <h1>üñ•Ô∏è Fiche de D√©p√¥t - sosordi03</h1>

  <!-- Recherche client -->
  <input type="text" id="search" class="input" placeholder="üîç Rechercher un client..." oninput="rechercherClient()">
  <div id="suggest" class="suggest-box"></div>

  <div class="card">

    <label>Nom du client :</label>
    <input id="nom" class="input" oninput="this.value=this.value.toUpperCase()">

    <label>T√©l√©phone :</label>
    <input id="tel" class="input" maxlength="14" oninput="formatTel();">

    <label>Mot de passe (optionnel) :</label>
    <input id="mdp" class="input">

    <!-- Appareils -->
    <div class="card-block">
      <label>Ajouter un appareil :</label>
      <div class="grid-3">
        <div>
          <label>Type :</label>
          <select id="type" class="input" onchange="majMarques()">
            <option>Ordinateur Portable</option>
            <option>Ordinateur Fixe</option>
            <option>Tablette</option>
            <option>Disque dur externe</option>
            <option>√âcran</option>
            <option>Imprimante</option>
            <option>Autre</option>
          </select>
        </div>
        <div>
          <label>Marque :</label>
          <select id="marque" class="input"></select>
        </div>
        <div>
          <label>Mod√®le :</label>
          <input id="modele" class="input">
        </div>
      </div>
      <button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï Ajouter cet appareil</button>
      <div id="listeAppareils"></div>
    </div>

    <!-- Sauvegarde -->
    <div class="card-block">
      <label>Sauvegarde :</label><br>
      <input type="radio" name="sauv" value="Non" checked> Non
      <input type="radio" name="sauv" value="Oui"> Oui

      <div id="optionsSauvegarde" style="display:none;margin-top:6px;">
        <label><input type="checkbox" name="sauv-item" value="Documents"> Documents</label><br>
        <label><input type="checkbox" name="sauv-item" value="Images"> Images</label><br>
        <label><input type="checkbox" name="sauv-item" value="Vid√©os"> Vid√©os</label><br>
        <label><input type="checkbox" name="sauv-item" value="Favoris"> Favoris</label><br>
        <label><input type="checkbox" name="sauv-item" value="Mots de passe"> Mots de passe</label><br>
      </div>
    </div>

    <!-- Travaux -->
    <div class="accordion">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        Travaux √† r√©aliser :
        <span class="arrow">‚ñº</span>
      </div>
      <div class="accordion-content">
        <div class="checkbox-group">
          <label><input type="checkbox" class="trav" value="Migration Windows 11"> Migration Windows 11</label>
          <label><input type="checkbox" class="trav" value="R√©installation compl√®te Windows"> R√©installation compl√®te Windows</label>
          <label><input type="checkbox" class="trav" value="Nettoyage syst√®me + Optimisation"> Nettoyage syst√®me + Optimisation</label>
          <label><input type="checkbox" class="trav" value="Suppression virus / malwares"> Suppression virus / malwares</label>
          <label><input type="checkbox" class="trav" value="Installation SSD + clonage"> Installation SSD + clonage</label>
          <label><input type="checkbox" class="trav" value="Sauvegarde + Restauration"> Sauvegarde + Restauration</label>
          <label><input type="checkbox" class="trav" value="Ajout / Changement RAM"> Ajout / Changement RAM</label>
          <label><input type="checkbox" class="trav" value="Autre"> Autre‚Ä¶</label>
        </div>
      </div>
    </div>

    <label>Description du probl√®me :</label>
    <textarea id="prob" class="textarea" rows="4"></textarea>

    <button class="primary" onclick="creer()">Cr√©er la fiche</button>
  </div>

  <div class="center"><a href="historique.html" class="link">üìö Voir l'historique</a></div>
</div>

</body>
</html>