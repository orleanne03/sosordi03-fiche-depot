<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t - sosordi03</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
</head>
<body>

<div class="container">

<h1>üñ•Ô∏è Fiche de D√©p√¥t - sosordi03</h1>

<input type="text" id="search" class="input" placeholder="üîç Rechercher un client..." oninput="rechercherClient()">
<div id="suggest" class="suggest-box"></div>

<div class="row import-row">
  <input type="file" id="csv" accept=".csv" class="input">
  <button class="secondary" onclick="importerCSV()">üì•</button>
</div>

<div class="card">

<div class="grid-2">
  <div>
    <label>Nom du client :</label>
    <input id="nom" class="input" oninput="this.value = this.value.toUpperCase()">
  </div>
  <div>
    <label>T√©l√©phone :</label>
    <input id="tel" class="input" maxlength="14" oninput="formatTel();verifierClient();">
    <button id="btnAddClient" class="secondary small-btn" style="display:none;" onclick="ajouterClient()">‚ûï Ajouter ce client</button>
  </div>
</div>

<!-- ‚úÖ Bloc Appareil -->
<div class="options-block">

<label>Appareil √† ajouter :</label>

<div class="grid-3">
  <div>
    <label>Type :</label>
    <select id="type" class="input">
      <option>Ordinateur Portable</option>
      <option>Ordinateur Fixe</option>
      <option>Tablette</option>
      <option>Disque dur externe</option>
      <option>√âcran</option>
      <option>Imprimante</option>
      <option>Autre</option>
    </select>
  </div>

  <div>
    <label>Marque :</label>
    <select id="marque" class="input"></select>
  </div>

  <div>
    <label>Mod√®le :</label>
    <input id="modele" class="input">
  </div>
</div>

<!-- Capacit√© Disque Dur -->
<div id="capBloc" style="display:none;">
  <label>Capacit√© :</label>
  <select id="capacite" class="input">
    <option>500 Go</option>
    <option>1 To</option>
    <option>2 To</option>
    <option>4 To</option>
    <option>5 To</option>
    <option>8 To</option>
  </select>
</div>

<!-- Taille √âcran -->
<div id="tailleBloc" style="display:none;">
  <label>Taille (pouces) :</label>
  <select id="taille" class="input">
    <option>22"</option>
    <option>24"</option>
    <option>27"</option>
    <option>32"</option>
    <option>34"</option>
  </select>
</div>

<button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï</button>

</div>

<!-- ‚úÖ Liste Appareils -->
<div id="listeAppareils" style="white-space:pre-line; font-size:16px;"></div>

<!-- ‚úÖ Sauvegarde -->
<div class="options-block">
  <label>Sauvegarde :</label>
  <div class="radio-group">
    <label><input type="radio" name="sauv" value="non" checked> Non</label>
    <label><input type="radio" name="sauv" value="oui"> Oui</label>
  </div>

  <div id="sauvDetails" class="checkbox-group" style="display:none;">
    <label><input type="checkbox" value="Documents"> Documents</label>
    <label><input type="checkbox" value="Images"> Images</label>
    <label><input type="checkbox" value="Vid√©os"> Vid√©os</label>
    <label><input type="checkbox" value="Favoris"> Favoris</label>
    <label><input type="checkbox" value="Mots de passe"> Mots de passe</label>
  </div>
</div>

<label>Description du probl√®me :</label>
<textarea id="prob" class="textarea" rows="4"></textarea>

<button class="primary" onclick="creer()">Cr√©er la fiche</button>

</div>

<div class="center">
  <a href="historique.html" class="link">üìö Voir l'historique</a>
</div>

</div>

<script>

// Format t√©l√©phone
function formatTel(){
  let v = tel.value.replace(/\D/g,"").slice(0,10);
  tel.value = v.replace(/(..)(?=.)/g,"$1-");
}

// CSV import
function importerCSV(){
  let file = csv.files[0]; if(!file) return alert("S√©lectionne un fichier CSV");
  let r=new FileReader();
  r.onload=e=>{
    let clients=e.target.result.split("\n").map(l=>{let c=l.split(";");return{nom:c[1]?.trim(),tel:c[5]?.trim()}});
    clients=clients.filter(x=>x.nom&&x.tel);
    localStorage.setItem("clients",JSON.stringify(clients));
    alert("‚úÖ Base clients import√©e !");
  };
  r.readAsText(file,"UTF-8");
}

// Suggestion clients
function rechercherClient(){
  let s=search.value.toLowerCase(),d=JSON.parse(localStorage.getItem("clients")||"[]");
  suggest.innerHTML="";suggest.style.display="none";if(s.length<2)return;
  d.filter(x=>x.nom.toLowerCase().includes(s)).forEach(c=>{
    suggest.innerHTML+=`<div class="sug" onclick='nom.value="${c.nom}";tel.value="${c.tel}";suggest.style.display="none"'>${c.nom} ‚Äî ${c.tel}</div>`;
  });
  suggest.style.display="block";
}

// V√©rification auto
function verifierClient(){
  let base=JSON.parse(localStorage.getItem("clients")||"[]");
  btnAddClient.style.display = base.some(c=>c.nom.toLowerCase()==nom.value.toLowerCase()&&c.tel==tel.value)?"none":"inline-block";
}
function ajouterClient(){
  let base=JSON.parse(localStorage.getItem("clients")||"[]");
  base.push({nom:nom.value.trim(),tel:tel.value.trim()});
  localStorage.setItem("clients",JSON.stringify(base));
  btnAddClient.style.display="none";
  alert("‚úÖ Client ajout√© !");
}

// Marques auto
const marquesParType = {
  "Ordinateur Portable": ["Acer","Asus","Dell","HP","Lenovo","MSI","Gigabyte","Medion","Toshiba","Packard Bell","Samsung","Apple (Mac)"],
  "Ordinateur Fixe": ["Assembl√©","Dell","HP","Lenovo","Acer","Asus","MSI"],
  "Tablette": ["Apple (iPad)","Samsung Galaxy Tab","Lenovo Tab","Huawei MediaPad","Amazon Fire HD"],
  "Disque dur externe": ["Seagate","Western Digital (WD)","Toshiba","LaCie","Samsung"],
  "√âcran": ["Samsung","LG","AOC","Iiyama","Asus","BenQ","HP","Dell","MSI"],
  "Imprimante": ["HP","Canon","Epson","Brother","Kyocera","Lexmark"],
  "Autre": []
};

function majMarques(){
  marque.innerHTML = "";
  let liste = marquesParType[type.value] || [];
  if(liste.length === 0){ marque.innerHTML = '<option>Non sp√©cifi√©</option>'; return; }
  liste.forEach(m => marque.innerHTML += `<option>${m}</option>`);
}
type.addEventListener("change", majMarques);
majMarques();

function majChamps(){
  capBloc.style.display = (type.value==="Disque dur externe") ? "block" : "none";
  tailleBloc.style.display = (type.value==="√âcran") ? "block" : "none";
}
type.addEventListener("change", majChamps);
majChamps();

// Tableau appareils
let appareils = [];

function ajouterAppareil(){
  appareils.push({
    type:type.value,
    marque:marque.value,
    modele:modele.value,
    capacite:(type.value==="Disque dur externe")?capacite.value:"",
    taille:(type.value==="√âcran")?taille.value:""
  });
  afficherAppareils();
  modele.value="";
}

function supprimerAppareil(i){
  appareils.splice(i,1);
  afficherAppareils();
}

function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>
`<div style="padding:8px 0;border-bottom:1px solid #dce3eb;">
<strong>${a.type}</strong><br>
Marque : ${a.marque}
${a.modele?"<br>Mod√®le : "+a.modele:""}
${a.capacite?"<br>Capacit√© : "+a.capacite:""}
${a.taille?"<br>Taille : "+a.taille:""}
<br><button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë Retirer</button>
</div>`
  ).join("");
}

// Sauvegarde
document.querySelectorAll("input[name='sauv']").forEach(r=>{
  r.addEventListener("change",()=>{sauvDetails.style.display=(r.value==="oui")?"block":"none";});
});

// Enregistrement fiche
function creer(){
  if(!nom.value.trim())return alert("Nom manquant");
  if(!tel.value.trim())return alert("T√©l√©phone manquant");
  if(appareils.length===0)return alert("Ajoute au moins un appareil");

  let sauv=document.querySelector("input[name='sauv']:checked").value;
  let sauvItems=[];
  if(sauv==="oui"){
    sauvDetails.querySelectorAll("input:checked").forEach(c=>sauvItems.push(c.value));
  }

  let h=JSON.parse(localStorage.getItem("historique")||"[]");
  h.push({
    id:Date.now(),
    nom:nom.value,
    tel:tel.value,
    appareils:appareils,
    probleme:prob.value,
    sauvegarde:sauv,
    sauvegardeElements:sauvItems,
    date:new Date().toLocaleDateString()
  });
  localStorage.setItem("historique",JSON.stringify(h));
  location.href="historique.html";
}

</script>

</body>
</html>
