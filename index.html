<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ========= CLIENT CACHE =========
let clientsCache = [];
let indexTel = {};

(async ()=>{
  let snap = await getDocs(collection(db,"clients"));
  snap.forEach(d=>{
    let c = d.data();
    clientsCache.push(c);
    let tel = (c.tel||"").replace(/\D/g,"");
    let prefix = tel.slice(0,3);
    if(prefix){
      if(!indexTel[prefix]) indexTel[prefix]=[];
      indexTel[prefix].push(c);
    }
  });
})();

// ========= RECHERCHE CLIENT =========

function rechercherClient(){
  let input = search.value.trim();
  let sU = input.toUpperCase();
  let telSearch = input.replace(/\D/g,"");

  suggest.innerHTML="";
  if(input.length < 2){ suggest.style.display="none"; return; }

  let res=[];

  if(telSearch.length >= 3){
    let prefix = telSearch.slice(0,3);
    let group = indexTel[prefix]||[];
    res = group.filter(c=>{
      let t = (c.tel||"").replace(/\D/g,"");
      return t.startsWith(telSearch);
    });
  }

  clientsCache.forEach(c=>{
    if(c.nom && c.nom.toUpperCase().startsWith(sU)) res.push(c);
  });

  let uniques=[];
  let seen=new Set();
  res.forEach(c=>{
    let k=c.nom+"|"+c.tel;
    if(!seen.has(k)){ seen.add(k); uniques.push(c);}
  });

  if(uniques.length===0){
    suggest.innerHTML=`<div class="sug" style="color:#b00;">Aucun r√©sultat</div>
    <button class="primary small-btn" style="width:100%;margin:6px 0;" onclick="ajouterNouveauClient()">‚ûï Ajouter ce client</button>`;
  } else {
    uniques.forEach(c=>{
      suggest.innerHTML+=`<div class="sug" onclick='remplirClient(${JSON.stringify(c.nom)},${JSON.stringify(c.tel)})'>
      ${c.nom} ‚Äî ${c.tel}
      </div>`;
    });
  }

  suggest.style.display="block";
}
window.rechercherClient = rechercherClient;

function remplirClient(n,t){
  nom.value=n;
  tel.value=t;
  suggest.style.display="none";
}
window.remplirClient = remplirClient;

async function ajouterNouveauClient(){
  let n = search.value.trim().toUpperCase();
  let t = tel.value.trim().replace(/\D/g,"");
  if(!n) return alert("Nom vide.");
  if(!t) return alert("T√©l√©phone manquant.");

  let snap = await getDocs(collection(db,"clients"));
  for(let d of snap.docs){
    let c=d.data();
    let telC=(c.tel||"").replace(/\D/g,"");
    if(c.nom===n || telC===t){
      nom.value=n;
      tel.value=t.replace(/(..)(?=.)/g,"$1-");
      suggest.style.display="none";
      alert("‚ö†Ô∏è Ce client existe d√©j√† !");
      return;
    }
  }

  let tF = t.replace(/(..)(?=.)/g,"$1-");
  await addDoc(collection(db,"clients"),{nom:n,tel:tF});
  clientsCache.push({nom:n,tel:tF});

  let prefix=t.slice(0,3);
  if(prefix){
    if(!indexTel[prefix]) indexTel[prefix]=[];
    indexTel[prefix].push({nom:n,tel:tF});
  }

  nom.value=n;
  tel.value=tF;
  suggest.style.display="none";
  alert("‚úÖ Client ajout√© !");
}
window.ajouterNouveauClient = ajouterNouveauClient;

function formatTel(){
  let v=tel.value.replace(/\D/g,"").slice(0,10);
  tel.value=v.replace(/(..)(?=.)/g,"$1-");
}

// ========= APPAREILS =========
let appareils=[];

function ajouterAppareil(){
  appareils.push({
    type:type.value,
    marque:marque.value,
    serie:serie.value||"",
    modele:(modeleAutre.style.display==="block"?modeleAutre.value:modele.value)||""
  });
  afficherAppareils();
  serie.value="";
  modele.value="";
  modeleAutre.value="";
}
window.ajouterAppareil = ajouterAppareil;

function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:6px;border-bottom:1px solid #ccc;">
    ${a.type} ‚Äî ${a.marque} ${a.serie?" "+a.serie:""} ${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}
function supprimerAppareil(i){ appareils.splice(i,1); afficherAppareils(); }
window.supprimerAppareil = supprimerAppareil;

// ========= ACCESSOIRES (GLOBAL) =========
let accessoires = [];

function toggleAcc(el){
  let val = el.value;
  if(el.checked){
    accessoires.push(val);
  } else {
    accessoires = accessoires.filter(v=>v!==val);
  }
}

function setAutres(){
  autres.value = autres.value.trim();
}
window.toggleAcc = toggleAcc;
window.setAutres = setAutres;

// ========= SAUVEGARDE =========
function toggleSauvegarde(){
  const v = document.querySelector('input[name="sauv"]:checked')?.value;
  optionsSauvegarde.style.display = (v==="Oui")?"block":"none";
}
document.querySelectorAll('input[name="sauv"]').forEach(r=>r.addEventListener("change",toggleSauvegarde));
toggleSauvegarde();

// ========= ENREGISTRER =========
async function creer(){
  if(!nom.value.trim()) return alert("Nom ?");
  if(!tel.value.trim()) return alert("T√©l√©phone ?");
  if(appareils.length===0) return alert("Ajoute au moins un appareil");

  let sauvegardeChoix = document.querySelector('input[name="sauv"]:checked')?.value || "Non";
  let sauvItems = [...document.querySelectorAll('input[name="sauv-item"]:checked')].map(c=>c.value);
  let travaux = [...document.querySelectorAll('.trav:checked')].map(c=>c.value);
  let accessoiresAutres = autres.value.trim() || "";

  await addDoc(collection(db,"fiches"),{
    nom: nom.value,
    tel: tel.value,
    appareils: appareils,
    sauvegarde: sauvegardeChoix,
    sauvegardeItems: sauvItems,
    travaux: travaux,
    accessoires: accessoires,
    accessoiresAutres: accessoiresAutres,
    probleme: prob.value,
    motdepasse: mdp.value.trim()||"",
    couleur: couleur.value||"",
    date: new Date().toISOString()
  });

  location.href="historique.html";
}
window.creer = creer;

document.addEventListener("click",e=>{ if(!e.target.closest("#search")&&!e.target.closest("#suggest")) suggest.style.display="none"; });
</script>
</head>

<body>
<div class="container">

<h1>üñ•Ô∏è Fiche de D√©p√¥t</h1>

<input type="text" id="search" class="input" placeholder="üîç Rechercher un client..." oninput="rechercherClient()">
<div id="suggest" class="suggest-box"></div>

<div class="card">

<label>Nom du client :</label>
<input id="nom" class="input">

<label>T√©l√©phone :</label>
<input id="tel" class="input" oninput="formatTel();">

<label>Couleur :</label>
<select id="couleur" class="input">
  <option value="">Aucune</option>
  <option value="red">Rouge</option>
  <option value="blue">Bleu</option>
  <option value="green">Vert</option>
  <option value="yellow">Jaune</option>
  <option value="orange">Orange</option>
</select>

<label>Mot de passe :</label>
<input id="mdp" class="input">

<div class="card-block">
<label>Ajouter un appareil :</label>

<div class="grid-3">
  <div><label>Type :</label><select id="type" class="input" onchange="majMarques()">
    <option disabled selected>-- Choisir --</option>
    <option>Ordinateur Portable</option><option>Ordinateur Fixe</option><option>Tablette</option>
    <option>Disque dur externe</option><option>√âcran</option><option>Imprimante</option><option>Autre</option>
  </select></div>

  <div><label>Marque :</label><select id="marque" class="input" onchange="majSeries()"></select></div>

  <div><label>S√©rie :</label><input id="serie" class="input"></div>

  <div style="grid-column:1/-1;">
    <label>Mod√®le :</label>
    <select id="modele" class="input" onchange="modeleAutre.style.display=(this.value==='autre'?'block':'none')"></select>
    <input id="modeleAutre" class="input" placeholder="Saisir mod√®le" style="display:none;margin-top:6px;">
  </div>
</div>

<!-- ‚úÖ ACCESSOIRES GLOBAUX (OPTION A) -->
<label>Accessoires fournis :</label>
<div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;">
  <label><input type="checkbox" value="Chargeur" onclick="toggleAcc(this)"> Chargeur</label>
  <label><input type="checkbox" value="Batterie externe" onclick="toggleAcc(this)"> Batterie externe</label>
  <label><input type="checkbox" value="Sacoche / Housse" onclick="toggleAcc(this)"> Sacoche / Housse</label>
  <label><input type="checkbox" value="Souris" onclick="toggleAcc(this)"> Souris</label>
  <label><input type="checkbox" value="Clavier" onclick="toggleAcc(this)"> Clavier</label>
  <label><input type="checkbox" value="C√¢ble USB" onclick="toggleAcc(this)"> C√¢ble USB</label>
  <label><input type="checkbox" value="C√¢ble HDMI" onclick="toggleAcc(this)"> C√¢ble HDMI</label>
  <label><input type="checkbox" value="Alimentation PC fixe" onclick="toggleAcc(this)"> Alimentation PC fixe</label>
  <label><input type="checkbox" value="Support / Dock" onclick="toggleAcc(this)"> Support / Dock</label>
</div>

<label>Autres accessoires :</label>
<input id="autres" class="input" oninput="setAutres()">

<button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï Ajouter ce mat√©riel</button>
<div id="listeAppareils"></div>
</div>

<div class="card-block">
<label>Sauvegarde :</label>
<input type="radio" name="sauv" value="Non" checked> Non
<input type="radio" name="sauv" value="Oui"> Oui
<div id="optionsSauvegarde" style="margin-top:6px;">
  <label><input type="checkbox" name="sauv-item" value="Documents"> Documents</label>
  <label><input type="checkbox" name="sauv-item" value="Images"> Images</label>
  <label><input type="checkbox" name="sauv-item" value="Vid√©os"> Vid√©os</label>
  <label><input type="checkbox" name="sauv-item" value="Favoris"> Favoris</label>
  <label><input type="checkbox" name="sauv-item" value="Mots de passe"> Mots de passe</label>
</div>
</div>

<div class="accordion">
  <div class="accordion-header" onclick="this.parentNode.classList.toggle('open')">
    Travaux √† r√©aliser :
    <span class="arrow">‚ñº</span>
  </div>

  <div class="accordion-content">
    <div class="checkbox-group">
      <label><input type="checkbox" class="trav" value="Migration Windows 11"> Migration Windows 11</label>
      <label><input type="checkbox" class="trav" value="R√©installation compl√®te Windows"> R√©installation compl√®te Windows</label>
      <label><input type="checkbox" class="trav" value="Nettoyage syst√®me + Optimisation"> Nettoyage + Optimisation</label>
      <label><input type="checkbox" class="trav" value="Suppression virus / malwares"> Suppression virus / malwares</label>
      <label><input type="checkbox" class="trav" value="Installation SSD + clonage"> Installation SSD + clonage</label>
      <label><input type="checkbox" class="trav" value="Sauvegarde + Restauration"> Sauvegarde + Restauration</label>
      <label><input type="checkbox" class="trav" value="Ajout / Changement RAM"> Ajout / Changement RAM</label>
      <label><input type="checkbox" class="trav" value="Autre"> Autre‚Ä¶</label>
    </div>
  </div>
</div>

<label>Description du probl√®me :</label>
<textarea id="prob" class="textarea" rows="4"></textarea>

<button class="primary" onclick="creer()">Cr√©er la fiche</button>

</div>

<div class="center"><a href="historique.html" class="link">üìö Voir l'historique</a></div>

</div>
</body>
</html>