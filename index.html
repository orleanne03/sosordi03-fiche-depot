<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, setDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// =============================================================
// CACHE CLIENTS + INDEX T√âL√âPHONE
// =============================================================
let clientsCache = [];
let indexTel = {};

(async ()=>{
  let snap = await getDocs(collection(db,"clients"));
  snap.forEach(d=>{
    let c = d.data();
    clientsCache.push(c);
    let tel = (c.tel || "").replace(/\D/g,"");
    let prefix = tel.slice(0,3);
    if(prefix){
      if(!indexTel[prefix]) indexTel[prefix] = [];
      indexTel[prefix].push(c);
    }
  });
})();

// =============================================================
// CLIENTS ‚Äî RECHERCHE + AJOUT
// =============================================================
async function ajouterNouveauClient(){
  let nomSaisi = nom.value.trim().toUpperCase();
  let telSaisi = tel.value.trim().replace(/\D/g,"");
  if(!nomSaisi) return alert("Nom vide.");
  if(!telSaisi) return alert("T√©l√©phone manquant.");

  // V√©rifie localement si le client existe d√©j√†
  let existe = clientsCache.some(c => 
    c.nom === nomSaisi || (c.tel || "").replace(/\D/g,"") === telSaisi
  );
  if(existe){
    nom.value = nomSaisi;
    tel.value = telSaisi.replace(/(..)(?=.)/g,"$1-");
    suggest.style.display="none";
    alert("‚ö†Ô∏è Ce client existe d√©j√† !");
    return;
  }

  let telFormate = telSaisi.replace(/(..)(?=.)/g,"$1-");

  await addDoc(collection(db,"clients"),{ nom: nomSaisi, tel: telFormate });
  clientsCache.push({ nom: nomSaisi, tel: telFormate });

  let prefix = telSaisi.slice(0,3);
  if(prefix){
    if(!indexTel[prefix]) indexTel[prefix] = [];
    indexTel[prefix].push({ nom: nomSaisi, tel: telFormate });
  }

  nom.value = nomSaisi;
  tel.value = telFormate;
  suggest.style.display="none";
  alert("‚úÖ Client ajout√© !");
}
window.ajouterNouveauClient = ajouterNouveauClient;

function formatTel(){
  let v = tel.value.replace(/\D/g,"").slice(0,10);
  tel.value = v.replace(/(..)(?=.)/g,"$1-");
}

// =============================================================
// RECHERCHE PAR NOM
// =============================================================
function rechercherClientDepuisNom(){
  rechercherClient();
}

function rechercherClient(){
  let input = nom.value.trim();
  let searchUpper = input.toUpperCase();
  let telSearch = input.replace(/\D/g,"");

  suggest.innerHTML = "";
  if(input.length < 2){ suggest.style.display="none"; return; }

  let results = [];

  // Recherche par t√©l√©phone
  if(telSearch.length >= 3){
    let prefix = telSearch.slice(0,3);
    let group = indexTel[prefix] || [];
    results = group.filter(c=>{
      let telClean = (c.tel || "").replace(/\D/g,"");
      return telClean.startsWith(telSearch);
    });
  }

  // Recherche par nom
  clientsCache.forEach(c=>{
    if(c.nom && c.nom.toUpperCase().includes(searchUpper)) results.push(c);
  });

  let uniques = [];
  let seen = new Set();
  results.forEach(c=>{
    let key = c.nom+"|"+c.tel;
    if(!seen.has(key)){
      seen.add(key);
      uniques.push(c);
    }
  });

  afficherSuggestions(uniques);
}
window.rechercherClientDepuisNom = rechercherClientDepuisNom;

// =============================================================
// RECHERCHE PAR T√âL√âPHONE
// =============================================================
function rechercherClientDepuisTel(){
  let input = tel.value.trim();
  let telSearch = input.replace(/\D/g,"");

  suggest.innerHTML = "";
  if(telSearch.length < 3){ suggest.style.display="none"; return; }

  let prefix = telSearch.slice(0,3);
  let group = indexTel[prefix] || [];
  let results = group.filter(c=>{
    let telClean = (c.tel || "").replace(/\D/g,"");
    return telClean.startsWith(telSearch);
  });

  let uniques = [];
  let seen = new Set();
  results.forEach(c=>{
    let key = c.nom+"|"+c.tel;
    if(!seen.has(key)){
      seen.add(key);
      uniques.push(c);
    }
  });

  afficherSuggestions(uniques);
}
window.rechercherClientDepuisTel = rechercherClientDepuisTel;

// =============================================================
// SUGGESTIONS (AFFICHAGE UNIQUE)
// =============================================================
function afficherSuggestions(uniques){
  suggest.innerHTML = "";
  if(uniques.length === 0){
    suggest.innerHTML = `
      <div class="sug" style="color:#b00;">Aucun r√©sultat</div>
      <button class="primary small-btn" onclick="ajouterNouveauClient()">‚ûï Ajouter ce client</button>`;
  } else {
    uniques.forEach(c=>{
      suggest.innerHTML += `
      <div class="sug" onclick='remplirClient(${JSON.stringify(c.nom)}, ${JSON.stringify(c.tel)})'>
        ${c.nom} ‚Äî ${c.tel}
      </div>`;
    });
  }
  suggest.style.display = "block";
}

function remplirClient(n,t){
  nom.value = n;
  tel.value = t;
  suggest.style.display="none";
}
window.remplirClient = remplirClient;

// ferme la bo√Æte de suggestion si on clique ailleurs
document.addEventListener("click", e=>{
  if(!e.target.closest("#nom") && !e.target.closest("#tel") && !e.target.closest("#suggest"))
    suggest.style.display="none";
});

// =============================================================
// APPAREILS
// =============================================================
let appareils = [];
function ajouterAppareil(){
  appareils.push({ 
    type:type.value, 
    marque:marque.value, 
    serie:serie.value || "", 
    modele:(modeleAutre.style.display==="block" ? modeleAutre.value : modele.value)
  });
  afficherAppareils();
  modele.value=""; modeleAutre.value=""; serie.value="";
  majMarques();
}
function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:6px;border-bottom:1px solid #ccc;">
    ${a.type} ‚Äî ${a.marque} ${a.serie ? a.serie+" " : ""}${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}
function supprimerAppareil(i){ appareils.splice(i,1); afficherAppareils(); }
window.ajouterAppareil = ajouterAppareil;

const marquesParType = {
  "Ordinateur Portable": ["Acer","Asus","HP","Lenovo","Dell","MSI","Samsung","Toshiba","Fujitsu","LG","Autre"],
  "Ordinateur Fixe": ["Assembler","Acer","Asus","HP","Dell","Lenovo","MSI","Autre"],
  "Tablette": ["Samsung","Lenovo","Huawei","Microsoft Surface","Autre"],
  "Disque dur externe": ["Seagate","Western Digital","Toshiba","Samsung","LaCie","Autre"],
  "√âcran": ["Samsung","LG","AOC","Iiyama","Philips","Dell","Asus","Autre"],
  "Imprimante": ["HP","Canon","Epson","Brother","Lexmark","Samsung","Autre"],
  "Autre": ["Autre"]
};

let seriesParMarque = {};
let modelesParSerie = {};

async function chargerAutoData(){
  let snapSeries = await getDocs(collection(db,"series"));
  snapSeries.forEach(d=> seriesParMarque[d.id] = d.data().liste || []);

  let snapModeles = await getDocs(collection(db,"modeles"));
  snapModeles.forEach(d=> modelesParSerie[d.id] = d.data().liste || []);
}
await chargerAutoData();

function majMarques(){
  marque.innerHTML = "";
  (marquesParType[type.value] || []).forEach(m=> marque.innerHTML += `<option>${m}</option>`);
  majSeries();
}
window.majMarques = majMarques;

function majSeries(){
  let liste = seriesParMarque[marque.value] || [];
  document.getElementById("serie-block").style.display = (liste.length === 0) ? "none" : "block";
  serie.innerHTML = "";
  liste.forEach(s=> serie.innerHTML += `<option>${s}</option>`);
  majModeles();
}
window.majSeries = majSeries;

function majModeles(){
  let key = (marque.value || "") + "__" + (serie.value || "");
  let liste = modelesParSerie[key] || [];
  modele.innerHTML = "";
  liste.forEach(m=> modele.innerHTML += `<option>${m}</option>`);
  modele.innerHTML += `<option value="autre">Autre (Saisie manuelle)</option>`;
}
window.majModeles = majModeles;

// =============================================================
// SAUVEGARDE + ENREGISTREMENT
// =============================================================
function toggleSauvegarde(){
  const v = document.querySelector('input[name="sauv"]:checked')?.value;
  optionsSauvegarde.style.display = (v === "Oui") ? "block" : "none";
}
document.querySelectorAll('input[name="sauv"]').forEach(r=>r.addEventListener("change",toggleSauvegarde));
toggleSauvegarde();

async function enregistrer(){
  let s = (serie.value || "").trim();
  let m = (modeleAutre.style.display==="block" ? (modeleAutre.value || "").trim() : (modele.value || "").trim());
  let mk = marque.value;

  if(s){
    if(!seriesParMarque[mk]) seriesParMarque[mk] = [];
    if(!seriesParMarque[mk].includes(s)){
      seriesParMarque[mk].push(s);
      await setDoc(doc(db,"series",mk), { liste:seriesParMarque[mk] });
    }
  }

  let key = mk+"__"+(s || "");
  if(!modelesParSerie[key]) modelesParSerie[key] = [];
  if(m && !modelesParSerie[key].includes(m)){
    modelesParSerie[key].push(m);
    await setDoc(doc(db,"modeles",key), { liste:modelesParSerie[key] });
  }
}

async function creer(){
  if(!nom.value.trim()) return alert("Nom manquant");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant");
  if(appareils.length === 0) return alert("Ajoute au moins un appareil");

  await enregistrer();

  let sauvegardeChoix = document.querySelector('input[name="sauv"]:checked')?.value || "Non";
  let sauvItems = [...document.querySelectorAll('input[name="sauv-item"]:checked')].map(c => c.value);
  let travauxSelectionnes = [...document.querySelectorAll('.trav:checked')].map(c => c.value);
  let accessoiresSelectionnes = [...document.querySelectorAll('input[name="acc"]:checked')].map(c => c.value);
  let accessoiresAutres = (accAutres.value || "").trim();

  await addDoc(collection(db,"fiches"),{
    nom: nom.value,
    tel: tel.value,
    appareils: appareils,
    probleme: prob.value,
    sauvegarde: sauvegardeChoix,
    sauvegardeItems: sauvItems,
    travaux: travauxSelectionnes,
    accessoires: accessoiresSelectionnes,
    accessoiresAutres: accessoiresAutres,
    motdepasse: mdp.value.trim() || "",
    couleur: couleur.value || "",
    date: new Date().toISOString()
  });

  alert("‚úÖ Fiche cr√©√©e !");
  setTimeout(()=>location.href="historique.html",500);
}
window.creer = creer;

</script>
</head>
<body>

<div class="container">
<h1>üñ•Ô∏è Fiche de D√©p√¥t</h1>

<!-- RECHERCHE CLIENT -->
<label>Nom du client :</label>
<input id="nom" class="input" autocomplete="off" oninput="rechercherClientDepuisNom()">

<label>T√©l√©phone :</label>
<input id="tel" class="input" maxlength="14" inputmode="numeric" oninput="formatTel();rechercherClientDepuisTel();">

<!-- bo√Æte de suggestion sous les deux champs -->
<div id="suggest" class="suggest-box"></div>

<label>Couleur :</label>
<select id="couleur" class="input">
  <option value="">Aucune</option>
  <option value="red">Rouge</option>
  <option value="blue">Bleu</option>
  <option value="green">Vert</option>
  <option value="yellow">Jaune</option>
  <option value="orange">Orange</option>
</select>

<label>Mot de passe :</label>
<input id="mdp" class="input">

<!-- MAT√âRIEL D√âPOS√â -->
<div class="card-block">
<label>Ajouter un appareil :</label>
<div class="grid-3">

  <div><label>Type :</label><select id="type" class="input" onchange="majMarques()">
    <option value="" selected disabled>-- Choisir un type --</option>
    <option>Ordinateur Portable</option><option>Ordinateur Fixe</option><option>Tablette</option>
    <option>Disque dur externe</option><option>√âcran</option><option>Imprimante</option><option>Autre</option>
  </select></div>

  <div><label>Marque :</label><select id="marque" class="input" onchange="majSeries()"></select></div>

  <div id="serie-block" style="display:none;">
    <label>S√©rie :</label>
    <select id="serie" class="input" onchange="majModeles()"></select>
  </div>

<div>
  <label>Mod√®le :</label>
  <select id="modele" class="input"></select>
  <input id="modeleAutre" class="input" placeholder="Saisir mod√®le" style="display:none;margin-top:6px;">
</div>

<script>
  // ‚úÖ Surveille les changements de s√©lection du menu "modele"
  document.addEventListener("change", e => {
    if (e.target && e.target.id === "modele") {
      const autreChamp = document.getElementById("modeleAutre");
      if (e.target.value === "autre") {
        autreChamp.style.display = "block";
        autreChamp.focus(); // met le curseur directement dedans
      } else {
        autreChamp.style.display = "none";
        autreChamp.value = ""; // r√©initialise si on re-choisit un mod√®le normal
      }
    }
  });
</script>


</div>

<button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï</button>
<div id="listeAppareils"></div>
</div>

<!-- ACCESSOIRES -->
<div class="accordion">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    Accessoires fournis :
    <span class="arrow">‚ñº</span>
  </div>
  <div class="accordion-content">
    <div class="checkbox-group">
      <label><input type="checkbox" name="acc" value="Chargeur"> Chargeur</label>
      <label><input type="checkbox" name="acc" value="Batterie externe"> Batterie externe</label>
      <label><input type="checkbox" name="acc" value="Sacoche / Housse"> Sacoche / Housse</label>
      <label><input type="checkbox" name="acc" value="Souris"> Souris</label>
      <label><input type="checkbox" name="acc" value="Clavier"> Clavier</label>
      <label><input type="checkbox" name="acc" value="C√¢ble USB"> C√¢ble USB</label>
      <label><input type="checkbox" name="acc" value="C√¢ble HDMI"> C√¢ble HDMI</label>
      <label><input type="checkbox" name="acc" value="Alimentation PC fixe"> Alimentation PC fixe</label>
      <label><input type="checkbox" name="acc" value="Support / Dock"> Support / Dock</label>
    </div>
    <label style="margin-top:10px;">Autres :</label>
    <input id="accAutres" class="input" placeholder="Ex : Adaptateur USB-C ‚Üî RJ45‚Ä¶">
  </div>
</div>

<!-- SAUVEGARDE -->
<div class="card-block">
<label>Sauvegarde :</label>

<div style="display:flex; gap:20px; align-items:center; margin-top:8px;">
  <label style="display:flex; align-items:center; gap:6px;">
    <input type="radio" name="sauv" value="Non" checked>
    Non
  </label>

  <label style="display:flex; align-items:center; gap:6px;">
    <input type="radio" name="sauv" value="Oui">
    Oui
  </label>
</div>

<div id="optionsSauvegarde" style="display:none;margin-top:6px;">
  <label><input type="checkbox" name="sauv-item" value="Documents"> Documents</label><br>
  <label><input type="checkbox" name="sauv-item" value="Images"> Images</label><br>
  <label><input type="checkbox" name="sauv-item" value="Vid√©os"> Vid√©os</label><br>
  <label><input type="checkbox" name="sauv-item" value="Favoris"> Favoris</label><br>
  <label><input type="checkbox" name="sauv-item" value="Mots de passe"> Motsde passe</label><br>
</div>
</div>

<!-- TRAVAUX -->
<div class="accordion">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    Travaux √† r√©aliser :
    <span class="arrow">‚ñº</span>
  </div>

  <div class="accordion-content">
    <div class="checkbox-group">
      <label><input type="checkbox" class="trav" value="Migration Windows 11"> Migration Windows 11</label>
      <label><input type="checkbox" class="trav" value="R√©installation compl√®te Windows"> R√©installation compl√®te Windows</label>
      <label><input type="checkbox" class="trav" value="Nettoyage syst√®me + Optimisation"> Nettoyage + Optimisation</label>
      <label><input type="checkbox" class="trav" value="Suppression virus / malwares"> Suppression virus / malwares</label>
      <label><input type="checkbox" class="trav" value="Installation SSD + clonage"> Installation SSD + clonage</label>
      <label><input type="checkbox" class="trav" value="Sauvegarde + Restauration"> Sauvegarde + Restauration</label>
      <label><input type="checkbox" class="trav" value="Ajout / Changement RAM"> Ajout / Changement RAM</label>
      <label><input type="checkbox" class="trav" value="Autre"> Autre‚Ä¶</label>
    </div>
  </div>
</div>

<label>Description du probl√®me :</label>
<textarea id="prob" class="textarea" rows="4"></textarea>

<button class="primary" onclick="creer()">Cr√©er la fiche</button>

<!-- ‚úÖ LIEN HISTORIQUE EN BAS -->
<div class="center" style="margin-top:20px;">
  <a href="historique.html" class="link">üìö Voir l'historique</a>
</div>

</div>

<script>
function toggleAccordion(el){
  el.parentNode.classList.toggle("open");
}
</script>

</body>
</html>
