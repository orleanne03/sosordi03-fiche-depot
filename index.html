<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t - sosordi03</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy, startAt, endAt,
  writeBatch, doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
window.db = getFirestore(app);
window.collection = collection;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.query = query;
window.orderBy = orderBy;
window.startAt = startAt;
window.endAt = endAt;
window.writeBatch = writeBatch;
window.doc = doc;

function toggleAccordion(el){
    el.parentNode.classList.toggle("open");
  }
  window.toggleAccordion = toggleAccordion;
</script>

<style>
/* Style rapidos pour bloc carte mobile */
.card-block { background:#f6f9fc;padding:12px;border-radius:8px;margin-top:12px;border:1px solid #d8e0e8; }
.accordion { margin-top:12px; border:1px solid #dce6f0; border-radius:8px; overflow:hidden; }
.accordion-header { padding:10px 12px; background:#f4f7fb; cursor:pointer; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
.accordion-content { display:none; padding:10px 12px; }
.accordion.open .accordion-content { display:block; }
.accordion .arrow { opacity:.7; font-size:12px; margin-left:8px; }
</style>

</head>
<body>

<div class="container">

<h1>üñ•Ô∏è Fiche de D√©p√¥t - sosordi03</h1>

<input type="text" id="search" class="input" placeholder="üîç Rechercher un client..." oninput="rechercherClient()">
<div id="suggest" class="suggest-box"></div>

<div class="card">

<label>Nom du client :</label>
<input id="nom" class="input" oninput="this.value = this.value.toUpperCase()">

<label>T√©l√©phone :</label>
<input id="tel" class="input" maxlength="14" oninput="formatTel();">

<!-- === NOUVEAU : Mot de passe client + option majuscule initiale === -->
<div class="card-block" style="margin-top:12px;">
  <label>Mot de passe du client (facultatif) :</label>
  <input id="mdp" class="input" placeholder="Saisir le mot de passe">

  <div style="margin-top:8px;">
    <label style="font-weight:600;display:block;margin-bottom:6px;">Format du mot de passe :</label>
    <label><input type="radio" name="mdpCap" value="no" checked> Respecter la saisie (ne pas modifier)</label><br>
    <label><input type="radio" name="mdpCap" value="firstUpper"> Mettre la premi√®re lettre en majuscule</label>
  </div>
</div>
<!-- === FIN === -->

<!-- ‚úÖ Bloc Appareils en PREMIER (mobile ok) -->
<div class="card-block">
<label>Ajouter un appareil :</label>

<div class="grid-3">
  <div>
    <label>Type :</label>
    <select id="type" class="input" onchange="majMarques()">
      <option>Ordinateur Portable</option>
      <option>Ordinateur Fixe</option>
      <option>Tablette</option>
      <option>Disque dur externe</option>
      <option>√âcran</option>
      <option>Imprimante</option>
      <option>Autre</option>
    </select>
  </div>

  <div>
    <label>Marque :</label>
    <select id="marque" class="input"></select>
  </div>

  <div>
    <label>Mod√®le :</label>
    <input id="modele" class="input">
  </div>
</div>


<button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï Ajouter cet appareil</button>
<div id="listeAppareils"></div>
</div>

<!-- ‚úÖ Sauvegarde -->
<div class="card-block">
<label>Sauvegarde :</label><br>
<input type="radio" name="sauv" value="Non" checked> Non
<input type="radio" name="sauv" value="Oui"> Oui

<div id="optionsSauvegarde" style="display:none;margin-top:6px;">
  <label><input type="checkbox" name="sauv-item" value="Documents"> Documents</label><br>
  <label><input type="checkbox" name="sauv-item" value="Images"> Images</label><br>
  <label><input type="checkbox" name="sauv-item" value="Vid√©os"> Vid√©os</label><br>
  <label><input type="checkbox" name="sauv-item" value="Favoris"> Favoris</label><br>
  <label><input type="checkbox" name="sauv-item" value="Mots de passe"> Mots de passe</label><br>
</div>

</div>

<!-- ‚úÖ Travaux -->
<div class="accordion">
  <div class="accordion-header" onclick="toggleAccordion(this)">
    Travaux √† r√©aliser :
    <span class="arrow">‚ñº</span>
  </div>

  <div class="accordion-content">
    <div class="checkbox-group">
      <label><input type="checkbox" class="trav" value="Migration Windows 11"> Migration vers Windows 11</label>
      <label><input type="checkbox" class="trav" value="R√©installation compl√®te Windows"> R√©installation compl√®te Windows</label>
      <label><input type="checkbox" class="trav" value="Nettoyage syst√®me + Optimisation"> Nettoyage syst√®me + Optimisation</label>
      <label><input type="checkbox" class="trav" value="Suppression virus / malwares"> Suppression virus / malwares</label>
      <label><input type="checkbox" class="trav" value="Sauvegarde + Restauration"> Sauvegarde + Restauration</label>
      <label><input type="checkbox" class="trav" value="Installation SSD + clonage"> Installation SSD + clonage</label>
      <label><input type="checkbox" class="trav" value="Ajout / Changement RAM"> Ajout / Changement RAM</label>
      <label><input type="checkbox" class="trav" value="Autre"> Autre‚Ä¶</label>
    </div>
  </div>
</div>

<label>Description du probl√®me :</label>
<textarea id="prob" class="textarea" rows="4"></textarea>

<button class="primary" onclick="creer()">Cr√©er la fiche</button>

</div>

<div class="center">
  <a href="historique.html" class="link">üìö Voir l'historique</a>
</div>

</div>

<script>
// ----------------------------------------------------------
// FORMAT T√âL√âPHONE
function formatTel(){ let v = tel.value.replace(/\D/g,"").slice(0,10); tel.value = v.replace(/(..)(?=.)/g,"$1-"); }

// ----------------------------------------------------------
// RECHERCHE CLIENT
async function rechercherClient(){
  let val = search.value.trim().toUpperCase();
  suggest.innerHTML = ""; if(val.length < 2) return;
  let q = query(collection(db, "clients"), orderBy("nom"), startAt(val), endAt(val + "\uf8ff"));
  let snap = await getDocs(q);
  snap.forEach(doc=>{ let c = doc.data(); suggest.innerHTML += `<div class="sug" onclick='remplirClient("${c.nom}","${c.tel}")'>${c.nom} ‚Äî ${c.tel}</div>`; });
  suggest.style.display = "block";
}
function remplirClient(n,t){ nom.value = n; tel.value = t; suggest.style.display = "none"; }

// ----------------------------------------------------------
// APPAREILS
let appareils = [];
function ajouterAppareil(){
  appareils.push({ type:type.value, marque:marque.value, modele:modele.value });
  afficherAppareils(); modele.value="";
}
function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:6px;border-bottom:1px solid #ccc;">
    ${a.type} ‚Äî ${a.marque} ${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}
function supprimerAppareil(i){ appareils.splice(i,1); afficherAppareils(); }

// ----------------------------------------------------------
// AFFICHAGE OPTIONS SAUVEGARDE
document.querySelectorAll('input[name="sauv"]').forEach(r=>{
  r.onchange = ()=>{ optionsSauvegarde.style.display = (r.value==="Oui")?"block":"none"; };
});

// ----------------------------------------------------------
// CR√âATION FICHE (avec auto-ajout client)
async function creer(){
  if(!nom.value.trim()) return alert("Nom manquant");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant");
  if(appareils.length === 0) return alert("Ajoute au moins un appareil");

// ‚úÖ Sauvegarde Oui/Non
let sauvegardeChoix = document.querySelector('input[name="sauv"]:checked')?.value || "Non";

// ‚úÖ D√©tails sauvegarde
let sauvItems = [...document.querySelectorAll('input[name="sauv-item"]:checked')]
    .map(c => c.value);

// ‚úÖ Travaux coch√©s
let travauxSelectionnes = [...document.querySelectorAll('.trav:checked')]
    .map(c => c.value);

// ‚úÖ Mot de passe et option de capitalisation
let mdpRaw = (document.getElementById("mdp").value || "").trim();
let mdpOption = document.querySelector('input[name="mdpCap"]:checked')?.value || "no";
let mdpFinal = mdpRaw;
if(mdpRaw && mdpOption === "firstUpper"){
  mdpFinal = mdpRaw.charAt(0).toUpperCase() + mdpRaw.slice(1);
}

  await addDoc(collection(db,"fiches"),{
    nom: nom.value,
    tel: tel.value,
    appareils: appareils,
    probleme: prob.value,
    sauvegarde: sauvegardeChoix,
    sauvegardeItems: sauvItems,
    travaux: travauxSelectionnes,
    password: mdpFinal,          // <-- mot de passe stock√©
    date: new Date().toISOString()
  });

  location.href="historique.html";
}
// üî• Fermer la liste si on clique ailleurs
document.addEventListener("click", function(e){
  if(!e.target.closest("#search") && !e.target.closest("#suggest")){
    suggest.style.display = "none";
  }
});

// üî• Fermer si champ vide
search.addEventListener("input", function(){
  if(search.value.trim().length < 2){
    suggest.style.display = "none";
  }
});

// üî• Fermer avec √âchap
document.addEventListener("keydown", function(e){
  if(e.key === "Escape"){
    suggest.style.display = "none";
  }
});

</script>
<script>
  const marquesParType = {
    "Ordinateur Portable": ["Acer","Asus","HP","Lenovo","Dell","MSI","Apple","Samsung","Toshiba","Autre"],
    "Ordinateur Fixe": ["Assembler","Acer","Asus","HP","Dell","Lenovo","Autre"],
    "Tablette": ["Apple","Samsung","Lenovo","Huawei","Microsoft Surface","Autre"],
    "Disque dur externe": ["Seagate","Western Digital","Toshiba","Samsung","LaCie","Autre"],
    "√âcran": ["Samsung","LG","AOC","Iiyama","Philips","Dell","Asus","Autre"],
    "Imprimante": ["HP","Canon","Epson","Brother","Lexmark","Samsung","Autre"],
    "Autre": ["Autre"]
  };

  function majMarques(){
    let type = document.getElementById("type").value;
    let select = document.getElementById("marque");
    select.innerHTML = "";

    marquesParType[type].forEach(m=>{
      let opt = document.createElement("option");
      opt.textContent = m;
      select.appendChild(opt);
    });
  }

  majMarques(); // initialise au chargement

  // Si "Autre" est choisi ‚Üí champ texte libre
  document.getElementById("marque").addEventListener("change", function(){
    if(this.value === "Autre"){
      this.outerHTML = '<input id="marque" class="input" placeholder="Saisir la marque">';
    }
  });
  </script>

</body>
</html>