<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t - sosordi03</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- üî• Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy, startAt, endAt,
  writeBatch, doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};


const app = initializeApp(firebaseConfig);
window.db = getFirestore(app);
window.collection = collection;
window.addDoc = addDoc;
window.getDocs = getDocs;
window.query = query;
window.orderBy = orderBy;
window.startAt = startAt;
window.endAt = endAt;
window.writeBatch = writeBatch;
window.doc = doc;
</script>

</head>
<body>

<div class="container">

<h1>üñ•Ô∏è Fiche de D√©p√¥t - sosordi03</h1>

<input type="text" id="search" class="input" placeholder="üîç Rechercher un client..." oninput="rechercherClient()">
<div id="suggest" class="suggest-box"></div>

<!-- ‚úÖ Import JSON Clients -->
<div class="row import-row">
  <input type="file" id="jsonImport" accept=".json" class="input">
  <button class="secondary" onclick="importerClientsJSON()">üì• Import JSON Clients</button>
</div>

<div class="card">

<div class="grid-2">
  <div>
    <label>Nom du client :</label>
    <input id="nom" class="input" oninput="this.value = this.value.toUpperCase()">
  </div>
  <div>
    <label>T√©l√©phone :</label>
    <input id="tel" class="input" maxlength="14" oninput="formatTel();">
  </div>
</div>

<div class="options-block">

<label>Ajouter un appareil :</label>

<div class="grid-3">
  <div>
    <label>Type :</label>
    <select id="type" class="input">
      <option>Ordinateur Portable</option>
      <option>Ordinateur Fixe</option>
      <option>Tablette</option>
      <option>Disque dur externe</option>
      <option>√âcran</option>
      <option>Imprimante</option>
      <option>Autre</option>
    </select>
  </div>

  <div>
    <label>Marque :</label>
    <input id="marque" class="input">
  </div>

  <div>
    <label>Mod√®le :</label>
    <input id="modele" class="input">
  </div>
</div>

<button class="secondary small-btn" onclick="ajouterAppareil()">‚ûï Ajouter cet appareil</button>

</div>
<ul id="liste-clients"></ul>

<div id="listeAppareils"></div>

<label>Description du probl√®me :</label>
<textarea id="prob" class="textarea" rows="4"></textarea>

<button class="primary" onclick="creer()">Cr√©er la fiche</button>

</div>

<div class="center">
  <a href="historique.html" class="link">üìö Voir l'historique</a>
</div>

</div>

<script>

// ----------------------------------------------------------
// FORMAT T√âL√âPHONE
// ----------------------------------------------------------
function formatTel(){
  let v = tel.value.replace(/\D/g,"").slice(0,10);
  tel.value = v.replace(/(..)(?=.)/g,"$1-");
}

// ----------------------------------------------------------
// RECHERCHE CLIENT + AUTO SUGGESTION
// ----------------------------------------------------------
async function rechercherClient(){
  let val = search.value.trim().toUpperCase();
  suggest.innerHTML = "";
  if(val.length < 2) return;

  let q = query(
    collection(db, "clients"),
    orderBy("nom"),
    startAt(val),
    endAt(val + "\uf8ff")
  );

  let snap = await getDocs(q);
  snap.forEach(doc=>{
    let c = doc.data();
    suggest.innerHTML += `<div class="sug" onclick='remplirClient("${c.nom}","${c.tel}")'>${c.nom} ‚Äî ${c.tel}</div>`;
  });

  suggest.style.display = "block";
}
function remplirClient(n,t){
  nom.value = n;
  tel.value = t;
  suggest.style.display = "none";
}

// ----------------------------------------------------------
// AJOUT MULTI APPAREILS
// ----------------------------------------------------------
let appareils = [];

function ajouterAppareil(){
  appareils.push({
    type:type.value,
    marque:marque.value,
    modele:modele.value
  });
  afficherAppareils();
  modele.value="";
}

function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:8px 0;border-bottom:1px solid #dce3eb;">
    <strong>${a.type}</strong> ‚Äî ${a.marque} ${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}

function supprimerAppareil(i){
  appareils.splice(i,1);
  afficherAppareils();
}

// ----------------------------------------------------------
// CR√âATION FICHE ‚Üí FIRESTORE
// ----------------------------------------------------------
async function creer(){
  if(!nom.value.trim()) return alert("Nom manquant");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant");
  if(appareils.length === 0) return alert("Ajoute au moins un appareil");

  await addDoc(collection(db,"fiches"),{
    nom: nom.value,
    tel: tel.value,
    appareils: appareils,
    probleme: prob.value,
    date: new Date().toISOString()
  });

  location.href="historique.html";
}

// ----------------------------------------------------------
// IMPORT JSON CLIENTS ‚Üí ANTI-QUOTA
// ----------------------------------------------------------
async function importerClientsJSON(){
  let file = jsonImport.files[0];
  if(!file) return alert("S√©lectionne un fichier JSON");

  let txt = await file.text();
  let clients = JSON.parse(txt);
  let total = clients.length;
  let batchSize = 50;

  alert("‚è≥ Import en cours...");

  for(let i = 0; i < total; i += batchSize){
    let chunk = clients.slice(i, i + batchSize);
    let batch = writeBatch(db);

    chunk.forEach(c=>{
      batch.set(doc(collection(db,"clients")), { nom:c.nom, tel:c.tel });
    });

    await batch.commit();
    await new Promise(r => setTimeout(r, 800)); // pause anti quota
  }

  alert("‚úÖ Import termin√© !");
}

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  async function chargerClients() {
    const table = document.getElementById("liste-clients");
    const snap = await getDocs(collection(db, "clients"));
    snap.forEach(doc => {
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.nom} - ${data.tel}`;
      table.appendChild(li);
    });
  }
  
  chargerClients();
  </script>
  
</body>
</html>
