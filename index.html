<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Fiche de D√©p√¥t - sosordi03</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, orderBy, startAt, endAt,
  writeBatch, doc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
window.db = getFirestore(app);

// ----------------------------------------------------------
// AJOUT CLIENT SI NON TROUV√â
async function ajouterNouveauClient(){
  let nomSaisi = search.value.trim().toUpperCase();
  let telSaisi = tel.value.trim().replace(/\D/g,"");

  if(!nomSaisi) return alert("Nom vide.");
  if(!telSaisi) return alert("T√©l√©phone manquant.");

  let snap = await getDocs(collection(db,"clients"));
  for(let d of snap.docs){
    let c = d.data();
    let telClient = (c.tel || "").replace(/\D/g,"");
    if(c.nom === nomSaisi || telClient === telSaisi){
      nom.value = nomSaisi;
      tel.value = telSaisi.replace(/(..)(?=.)/g,"$1-");
      suggest.style.display="none";
      alert("‚ö†Ô∏è Ce client existe d√©j√† !");
      return;
    }
  }

  await addDoc(collection(db,"clients"),{
    nom: nomSaisi,
    tel: telSaisi.replace(/(..)(?=.)/g,"$1-")
  });

  nom.value = nomSaisi;
  tel.value = telSaisi.replace(/(..)(?=.)/g,"$1-");
  suggest.style.display="none";
  alert("‚úÖ Client ajout√© !");
}
window.ajouterNouveauClient = ajouterNouveauClient;

// ----------------------------------------------------------
// FORMAT T√âL√âPHONE (affichage)
function formatTel(){
  let v = tel.value.replace(/\D/g,"").slice(0,10);
  tel.value = v.replace(/(..)(?=.)/g,"$1-");
}

// ----------------------------------------------------------
// ‚úÖ RECHERCHE CLIENT (Nom OU T√©l√©phone normalis√©)
async function rechercherClient(){
  let input = search.value.trim();
  let searchUpper = input.toUpperCase();
  suggest.innerHTML = "";
  if(input.length < 2){ suggest.style.display="none"; return; }

  let all = await getDocs(collection(db,"clients"));
  let results = [];

  // --- T√©l√©phone ---
  let telSearch = input.replace(/\D/g,"");
  if(telSearch.length >= 2){
    all.forEach(doc=>{
      let c = doc.data();
      let stored = (c.tel || "").replace(/\D/g,"");
      if(stored.includes(telSearch)) results.push(c);
    });
  }

  // --- Nom ---
  all.forEach(doc=>{
    let c = doc.data();
    if(c.nom && c.nom.toUpperCase().includes(searchUpper)) results.push(c);
  });

  // --- Supprimer doublons ---
  let uniques = [];
  let seen = new Set();
  results.forEach(c=>{
    let key = c.nom+"|"+c.tel;
    if(!seen.has(key)){
      seen.add(key);
      uniques.push(c);
    }
  });

  // --- Affichage ---
  if(uniques.length === 0){
    suggest.innerHTML = `<div class="sug" style="color:#b00;">Aucun r√©sultat</div>
    <button class="primary small-btn" style="width:100%;margin:6px 0;" onclick="ajouterNouveauClient()">‚ûï Ajouter ce client</button>`;
  } else {
    uniques.forEach(c=>{
      suggest.innerHTML += `<div class="sug" onclick='remplirClient(${JSON.stringify(c.nom)}, ${JSON.stringify(c.tel)})'>${c.nom} ‚Äî ${c.tel}</div>`;
    });
  }

  suggest.style.display = "block";
}
window.rechercherClient = rechercherClient;

// ----------------------------------------------------------
// ‚úÖ Correction du clic
function remplirClient(n,t){
  nom.value = n;
  tel.value = t;
  suggest.style.display = "none";
}
window.remplirClient = remplirClient;

// ----------------------------------------------------------
// APPAREILS
let appareils = [];
function ajouterAppareil(){
  appareils.push({ type:type.value, marque:marque.value, modele:modele.value });
  afficherAppareils(); modele.value="";
}
function afficherAppareils(){
  listeAppareils.innerHTML = appareils.map((a,i)=>`
  <div style="padding:6px;border-bottom:1px solid #ccc;">
    ${a.type} ‚Äî ${a.marque} ${a.modele}
    <button class="danger small-btn" onclick="supprimerAppareil(${i})">üóë</button>
  </div>`).join("");
}
function supprimerAppareil(i){ appareils.splice(i,1); afficherAppareils(); }
window.ajouterAppareil = ajouterAppareil;

// ----------------------------------------------------------
// SAUVEGARDE
document.querySelectorAll('input[name="sauv"]').forEach(r=>{
  r.onchange = ()=>{ optionsSauvegarde.style.display = (r.value==="Oui")?"block":"none"; };
});

// ----------------------------------------------------------
// CR√âATION FICHE
async function creer(){
  if(!nom.value.trim()) return alert("Nom manquant");
  if(!tel.value.trim()) return alert("T√©l√©phone manquant");
  if(appareils.length === 0) return alert("Ajoute au moins un appareil");

let sauvegardeChoix = document.querySelector('input[name="sauv"]:checked')?.value || "Non";
let sauvItems = [...document.querySelectorAll('input[name="sauv-item"]:checked')].map(c => c.value);
let travauxSelectionnes = [...document.querySelectorAll('.trav:checked')].map(c => c.value);

await addDoc(collection(db,"fiches"),{
  nom: nom.value,
  tel: tel.value,
  appareils: appareils,
  probleme: prob.value,
  sauvegarde: sauvegardeChoix,
  sauvegardeItems: sauvItems,
  travaux: travauxSelectionnes,
  motdepasse: mdp.value.trim() || "",
  date: new Date().toISOString()
});

location.href="historique.html";
}
window.creer = creer;

// ----------------------------------------------------------
// FERMETURE LISTE
document.addEventListener("click", e=>{ if(!e.target.closest("#search") && !e.target.closest("#suggest")) suggest.style.display="none"; });
search.addEventListener("input", ()=>{ if(search.value.trim().length < 2) suggest.style.display="none"; });
document.addEventListener("keydown", e=>{ if(e.key==="Escape") suggest.style.display="none"; });

</script>

<script>
// MARQUES
const marquesParType = {
  "Ordinateur Portable": ["Acer","Asus","HP","Lenovo","Dell","MSI","Apple","Samsung","Toshiba","Autre"],
  "Ordinateur Fixe": ["Assembler","Acer","Asus","HP","Dell","Lenovo","Autre"],
  "Tablette": ["Apple","Samsung","Lenovo","Huawei","Microsoft Surface","Autre"],
  "Disque dur externe": ["Seagate","Western Digital","Toshiba","Samsung","LaCie","Autre"],
  "√âcran": ["Samsung","LG","AOC","Iiyama","Philips","Dell","Asus","Autre"],
  "Imprimante": ["HP","Canon","Epson","Brother","Lexmark","Samsung","Autre"],
  "Autre": ["Autre"]
};
function majMarques(){
  marque.innerHTML = "";
  marquesParType[type.value].forEach(m=> marque.innerHTML += `<option>${m}</option>`);
}
majMarques();
</script>

</head>
<body>
...
</body>
</html>