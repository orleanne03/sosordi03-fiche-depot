<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique - sosordi03</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
</head>
<body>

<div class="container">

<h1>üìö Historique des d√©p√¥ts</h1>

<div class="card" id="list"></div>

<div class="center">
  <a href="index.html" class="link">‚¨Ö Retour</a>
</div>

</div>

<script>

// Charger l'historique
let h = JSON.parse(localStorage.getItem("historique")||"[]");

// ‚úÖ Conversion anciennes fiches ‚Üí nouveau format
let modif = false;

h = h.map(f => {

  // Si d√©j√† multi-appareils ‚Üí on garde
  if (Array.isArray(f.appareils)) return f;

  // Sinon ‚Üí convertir ancien format en nouveau
  modif = true;
  return {
    id: f.id,
    nom: f.nom,
    tel: f.tel,
    appareils: [{
      type: f.type || "Non pr√©cis√©",
      marque: f.marque || "Non pr√©cis√©",
      modele: f.modele || "",
      capacite: f.capacite || "",
      taille: f.taille || ""
    }],
    probleme: f.probleme || "",
    sauvegarde: f.sauvegarde || "non",
    sauvegardeElements: f.sauvegardeElements || [],
    date: f.date || new Date().toLocaleDateString()
  };
});

// ‚úÖ Sauvegarde apr√®s conversion (1 seule fois)
if(modif){
  localStorage.setItem("historique", JSON.stringify(h));
}

// S'il n'y a rien ‚Üí message
if(h.length === 0){
  list.innerHTML = "<p>Aucune fiche pour le moment.</p>";
}

// Afficher les fiches en accord√©on
list.innerHTML = h.map((f,i)=>`

<div class="options-block" style="padding:14px;border-radius:10px;">

  <div onclick="toggle(${i})" style="display:flex;justify-content:space-between;cursor:pointer;">
    <div>
      <strong>${f.nom}</strong> ‚Äî ${f.tel}<br>
      <span style="font-size:14px;color:#555;">${f.date}</span>
    </div>
    <div style="font-size:22px;">‚Æü</div>
  </div>

  <div id="content-${i}" style="display:none;margin-top:10px;font-size:16px;line-height:1.5;">

    <label>Appareils d√©pos√©s :</label><br><br>

    ${f.appareils.map(a=>`
<strong>${a.type}</strong><br>
Marque : ${a.marque}
${a.modele ? "<br>Mod√®le : "+a.modele : ""}
${a.capacite ? "<br>Capacit√© : "+a.capacite : ""}
${a.taille ? "<br>Taille : "+a.taille : ""}
<br><br>
`).join("")}

    <label>Probl√®me signal√© :</label><br>
    ${f.probleme || "(Non pr√©cis√©)"}<br><br>

    <label>Sauvegarde :</label> ${f.sauvegarde === "oui" ? "Oui" : "Non"}<br>
    ${f.sauvegardeElements && f.sauvegardeElements.length>0 ? "√âl√©ments : "+f.sauvegardeElements.join(", ") : ""}

    <br><br>

    <button class="danger small-btn" onclick="supprimer(${f.id})">üóë Supprimer la fiche</button>

  </div>

</div>

`).join("");

// Accord√©on
function toggle(i){
  let c=document.getElementById("content-"+i);
  c.style.display = (c.style.display==="none") ? "block" : "none";
}

// Supprimer une fiche
function supprimer(id){
  if(!confirm("Supprimer cette fiche ?")) return;
  let h=JSON.parse(localStorage.getItem("historique")||"[]");
  h=h.filter(e=>e.id!==id);
  localStorage.setItem("historique",JSON.stringify(h));
  location.reload();
}

</script>

</body>
</html>
