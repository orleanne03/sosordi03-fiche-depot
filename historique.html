<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des dÃ©pÃ´ts</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, query, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function formatTelAffichage(t){
  if(!t) return "";
  let clean = t.replace(/\D/g,"");
  return clean.replace(/(..)(?=.)/g,"$1-");
}

async function supprimer(id){
  if(!confirm("Supprimer cette fiche ?")) return;
  await deleteDoc(doc(db,"fiches",id));
  location.reload();
}

async function load(){
  let snap = await getDocs(query(collection(db,"fiches"), orderBy("date","desc")));
  let zone = document.getElementById("liste");

  snap.forEach(d=>{
    let f = d.data();
    let appareils = f.appareils.map(a=>`â€¢ ${a.type} â€” ${a.marque} ${a.modele}`).join("<br>");
    let sauv = (f.sauvegarde==="Oui") ? `Oui (${f.sauvegardeItems.join(", ")})` : "Non";
    let travaux = (f.travaux?.length) ? f.travaux.join("<br>") : "Aucun";
    let mdp = f.motdepasse && f.motdepasse.trim() ? f.motdepasse : "Non renseignÃ©";

    zone.innerHTML += `
<div class="fiche-card accordion-card">

  <div class="fiche-header">
  <div class="fiche-header-left">
    <span class="color-tag" style="background:${f.couleur || 'transparent'}"></span>
    <span class="fiche-name">${f.nom}</span>
  </div>
  <button class="delete-btn" onclick="supprimer('${d.id}')">ğŸ—‘</button>
</div>

  <div class="fiche-content">
    <div class="fiche-date">ğŸ“… ${new Date(f.date).toLocaleDateString()}</div>

    <p>ğŸ“ ${formatTelAffichage(f.tel)}</p>
    <p>ğŸ’»<br>${appareils.replace(/â€¢/g,"ğŸ”¹")}</p>
    <p>ğŸ’¾ Sauvegarde : <strong>${sauv}</strong></p>
    <p>ğŸ” Mot de passe : <strong>${mdp}</strong></p>
    <p>ğŸ“ ${f.probleme}</p>
    <p>ğŸ”§ Travaux :<br> <strong>${travaux}</strong></p>
  </div>

</div>`;
  });
}
window.supprimer = supprimer;
load();
</script>
</head>

<body class="history-page">
<h1>ğŸ“š Historique des dÃ©pÃ´ts</h1>
<div id="liste" class="history-container"></div>
<div class="center"><a href="index.html" class="link return-link">â¬… Retour</a></div>
</body>
</html>