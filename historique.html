<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des dÃ©pÃ´ts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:0;
}
h1{text-align:center;margin:20px 0;}
.history-container{max-width:700px;margin:auto;padding:10px;}
.fiche-card{
  background:white;
  border-radius:8px;
  margin-bottom:12px;
  overflow:hidden;
  border:1px solid #ddd;
  transition:0.3s;
}
.fiche-header{
  display:flex;
  justify-content:space-between;
  padding:10px;
  background:#eee;
  cursor:pointer;
}
.fiche-header-left{
  display:flex;
  align-items:center;
  gap:8px;
}
.color-tag{
  width:14px;
  height:14px;
  border-radius:50%;
  border:1px solid #0003;
}
.delete-btn{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
}
.fiche-content{
  display:none;
  padding:10px;
  line-height:1.5em;
}
.fiche-card.open .fiche-content{display:block;}

.tarif-input{
  width:140px;
  padding:5px;
  border:1px solid #aaa;
  border-radius:5px;
  margin-top:4px;
}

.save-btn{
  margin-top:8px;
  padding:6px 10px;
  background:#2c7;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.center{text-align:center;margin:20px;}
.return-link{text-decoration:none;color:#333;font-weight:bold;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TARIFS â€“ 1 SEULE LIGNE, â‚¬ AUTO, DISQUETTE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tarifs-row{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;
  white-space:nowrap;
  margin-top:8px;
}
.tarifs-row .tarif-input{
  width:150px;           /* desktop */
  padding:8px 10px;
  border:1px solid #cbd4e1;
  border-radius:8px;
  background:#f9fbff;
  font-size:16px;
}
.tarifs-row .save-icon{
  background:#4caf50;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 10px;
  font-size:20px;
  cursor:pointer;
}
.tarifs-row .save-icon:hover{ background:#3b9440; }
.tarifs-row .emoji{
  font-size:18px;
  line-height:1;
  display:inline-flex;
  align-items:center;
}

/* plus compact sur smartphone pour tenir sur UNE ligne */
@media (max-width: 480px){
  .tarifs-row .tarif-input{ width:120px; font-size:15px; padding:6px 8px; }
  .tarifs-row .save-icon{ padding:6px 8px; font-size:18px; }
  .tarifs-row .emoji{ font-size:16px; }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, query, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function formatTelAffichage(t){
  if(!t) return "";
  let clean = t.replace(/\D/g,"");
  return clean.replace(/(..)(?=.)/g,"$1-");
}

async function supprimer(id){
  if(!confirm("Supprimer cette fiche ?")) return;
  await deleteDoc(doc(db,"fiches",id));
  location.reload();
}

/* âœ… Nouvelle sauvegarde : 1 seule case (tarifReel) */
async function saveTarifs(id){
  const input = document.getElementById("tarif_"+id);
  if(!input) return;

  // formatte "â‚¬" automatiquement avant enregistrement
  let v = (input.value || "").trim();
  if(v && !/â‚¬$/.test(v)) v = v.replace(/\s*â‚¬?$/, "") + " â‚¬";

  await updateDoc(doc(db, "fiches", id), {
    tarifReel: v
  });

  input.value = v; // reflÃ©ter le formatage
  alert("Tarif enregistrÃ© âœ…");
}
window.saveTarifs = saveTarifs;

/* âœ¨ format â‚¬ au blur */
function euroAuto(el){
  let v = (el.value || "").trim();
  if(!v) return;
  if(!/â‚¬$/.test(v)) el.value = v.replace(/\s*â‚¬?$/, "") + " â‚¬";
}
window.euroAuto = euroAuto;

function renderAccessoires(f){
  // Compat : accepte f.accessoires ou f.accessoiresFournis
  const list = (Array.isArray(f.accessoires) && f.accessoires.length ? f.accessoires
               : (Array.isArray(f.accessoiresFournis) ? f.accessoiresFournis : []));
  const autres = (f.accessoiresAutres || f.autresAccessoires || "").trim();

  if((list && list.length) || autres){
    let html = "";
    if(list && list.length){
      html += list.map(x=>"â€¢ "+x).join("<br>");
    }
    if(autres){
      if(html) html += "<br>";
      html += "â€¢ Autres : "+autres;
    }
    return html.replace(/â€¢/g,"ğŸ”¹");
  }
  return "Aucun";
}

async function load(){
  let snap = await getDocs(query(collection(db,"fiches"), orderBy("date","desc")));
  let zone = document.getElementById("liste");

  snap.forEach(d=>{
    let f = d.data();
    let appareils = (f.appareils || []).map(a=>`â€¢ ${a.type} â€” ${a.marque} ${a.modele || ""}`).join("<br>");
    let sauv = (f.sauvegarde==="Oui") ? `Oui (${(f.sauvegardeItems||[]).join(", ")})` : "Non";
    let travaux = (f.travaux?.length) ? f.travaux.join("<br>") : "Aucun";
    let mdp = f.motdepasse && f.motdepasse.trim() ? f.motdepasse : "Non renseignÃ©";
    let accHTML = renderAccessoires(f);

    zone.innerHTML += `
<div class="fiche-card accordion-card">

  <div class="fiche-header">
    <div class="fiche-header-left">
      <span class="color-tag" style="background:${f.couleur || 'transparent'}"></span>
      <span class="fiche-name">${f.nom}</span>
    </div>
    <button class="delete-btn" onclick="supprimer('${d.id}')">ğŸ—‘</button>
  </div>

  <div class="fiche-content">
    <div class="fiche-date">ğŸ“… ${new Date(f.date).toLocaleDateString()}</div>

    <p>ğŸ“ ${formatTelAffichage(f.tel)}</p>
    <p>ğŸ’»<br>${(appareils || "").replace(/â€¢/g,"ğŸ”¹")}</p>
    <p>ğŸ’ Accessoires fournis :<br><strong>${accHTML}</strong></p>
    <p>ğŸ’¾ Sauvegarde : <strong>${sauv}</strong></p>
    <p>ğŸ” Mot de passe : <strong>${mdp}</strong></p>
    <p>ğŸ”§ Travaux :<br> <strong>${travaux}</strong></p>
    <p>ğŸ“ ${f.probleme || ""}</p>

    <!-- â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â•‘   TARIF â€“ 1 CASE + DISQUETTE        â•‘
         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tarifs-row">
      <span class="emoji">ğŸ’°</span>
      <input type="text" id="tarif_${d.id}" class="tarif-input" value="${f.tarifReel || ""}" onblur="euroAuto(this)" placeholder="Montant">
      <button class="save-icon" title="Enregistrer" onclick="saveTarifs('${d.id}')">ğŸ’¾</button>
    </div>
  </div>

</div>`;
  });
}

window.supprimer = supprimer;
load();
</script>

<script>
document.addEventListener("click", function(e){
  let header = e.target.closest(".fiche-header");
  if(!header) return;
  header.parentNode.classList.toggle("open");
});
</script>

</head>

<body class="history-page">
<h1>ğŸ“š Historique des dÃ©pÃ´ts</h1>
<div id="liste" class="history-container"></div>
<div class="center"><a href="index.html" class="link return-link">â¬… Retour</a></div>
</body>
</html>