<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des dÃ©pÃ´ts</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs, orderBy, query,
  deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// âœ… SUPPRIMER UNE FICHE
async function supprimerFiche(id) {
  if(!confirm("Voulez-vous supprimer cette fiche ?")) return;
  try{
    await deleteDoc(doc(db, "fiches", id));
    // Retire la carte du DOM sans recharger toute la page
    const card = document.querySelector(`[data-id="${id}"]`);
    if(card) card.remove();
  }catch(e){
    alert("Erreur lors de la suppression : " + (e?.message || e));
  }
}
window.supprimerFiche = supprimerFiche;

// âœ… CHARGER LES FICHES
async function load(){
  const zone = document.getElementById("liste");
  zone.innerHTML = "";

  const snap = await getDocs(query(collection(db,"fiches"), orderBy("date","desc")));

  snap.forEach(d=>{
    const f = d.data();

    const appareils = Array.isArray(f.appareils)
      ? f.appareils.map(a => `â€¢ ${a.type} â€” ${a.marque ?? ""} ${a.modele ?? ""}`.trim()).join("<br>")
      : "";

    const travauxLisibles = (Array.isArray(f.travaux) && f.travaux.length)
      ? `<ul style="margin:6px 0 0 18px;">${f.travaux.map(t=>`<li>${t}</li>`).join("")}</ul>`
      : "Aucun";

    const sauvegardeTxt = (f.sauvegarde === "Oui")
      ? `Oui${(Array.isArray(f.sauvegardeItems) && f.sauvegardeItems.length) ? " ("+f.sauvegardeItems.join(", ")+")" : ""}`
      : "Non";

    const motdepasse = f.motdepasse && String(f.motdepasse).trim() ? f.motdepasse : "Non renseignÃ©";

    zone.innerHTML += `
      <div class="fiche-card" data-id="${d.id}">
        <button class="delete-btn" title="Supprimer" onclick="supprimerFiche('${d.id}')">ğŸ—‘</button>

        <h3>${f.nom} â€” ${f.tel}</h3>
        <small>ğŸ“… ${new Date(f.date).toLocaleDateString()}</small>

        <p>${appareils ? appareils.replace(/â€¢/g, "ğŸ’»") : ""}</p>
        <p>ğŸ’¾ Sauvegarde : <strong>${sauvegardeTxt}</strong></p>
        <p>ğŸ”§ Travaux : ${Array.isArray(f.travaux) && f.travaux.length ? travauxLisibles : "<strong>Aucun</strong>"}</p>
        <p>ğŸ“ <strong>ProblÃ¨me :</strong> ${f.probleme ?? ""}</p>
        <p>ğŸ”‘ <strong>Mot de passe :</strong> ${motdepasse}</p>
      </div>
    `;
  });
}

load();
</script>

<style>
/* âœ… Une seule colonne propre, cohÃ©rente avec votre style.css */
#liste {
  max-width: 700px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 22px;
}

.fiche-card{
  position: relative;
  background:#fff;
  padding:16px 18px;
  border-radius:12px;
  border:1px solid #d9dfe8;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}

.delete-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  border:none;
  font-size:20px;
  cursor:pointer;
  opacity:.6;
}
.delete-btn:hover{opacity:1;}
</style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“š Historique des dÃ©pÃ´ts</h1>

    <div id="liste"></div>

    <div class="center" style="margin-top:30px;">
      <a href="index.html" class="link">â¬… Retour</a>
    </div>
  </div>
</body>
</html>