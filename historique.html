<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des dÃ©pÃ´ts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:0;
}
h1{text-align:center;margin:20px 0;}
.history-container{max-width:700px;margin:auto;padding:10px;}
.fiche-card{
  background:white;
  border-radius:8px;
  margin-bottom:12px;
  overflow:hidden;
  border:1px solid #ddd;
  transition:0.3s;
}
.fiche-header{
  display:flex;
  justify-content:space-between;
  padding:10px;
  background:#eee;
  cursor:pointer;
}
.fiche-header-left{
  display:flex;
  align-items:center;
  gap:8px;
}
.color-tag{
  width:14px;
  height:14px;
  border-radius:50%;
  border:1px solid #0003;
}
.delete-btn{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
}
.fiche-content{
  display:none;
  padding:10px;
  line-height:1.5em;
}
.fiche-card.open .fiche-content{display:block;}

.tarif-input{
  width:140px;
  padding:5px;
  border:1px solid #aaa;
  border-radius:5px;
  margin-top:4px;
}

.save-btn{
  margin-top:8px;
  padding:6px 10px;
  background:#2c7;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.center{text-align:center;margin:20px;}
.return-link{text-decoration:none;color:#333;font-weight:bold;}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, query, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAR8PVlerANOGdzNBwZjj81I6Ajtbn63eI",
  authDomain: "sosordi03-sav.firebaseapp.com",
  projectId: "sosordi03-sav"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function formatTelAffichage(t){
  if(!t) return "";
  let clean = t.replace(/\D/g,"");
  return clean.replace(/(..)(?=.)/g,"$1-");
}

async function supprimer(id){
  if(!confirm("Supprimer cette fiche ?")) return;
  await deleteDoc(doc(db,"fiches",id));
  location.reload();
}

async function saveTarifs(id){
  let estimation = document.getElementById("est_"+id).value.trim();
  let reel = document.getElementById("reel_"+id).value.trim();

  await updateDoc(doc(db, "fiches", id), {
    tarifEstimation: estimation || "",
    tarifReel: reel || ""
  });

  alert("Tarifs mis Ã  jour âœ…");
}
window.saveTarifs = saveTarifs;

function renderAccessoires(f){
  // Compat : accepte f.accessoires ou f.accessoiresFournis
  const list = (Array.isArray(f.accessoires) && f.accessoires.length ? f.accessoires
               : (Array.isArray(f.accessoiresFournis) ? f.accessoiresFournis : []));
  const autres = (f.accessoiresAutres || f.autresAccessoires || "").trim();

  if((list && list.length) || autres){
    let html = "";
    if(list && list.length){
      html += list.map(x=>"â€¢ "+x).join("<br>");
    }
    if(autres){
      if(html) html += "<br>";
      html += "â€¢ Autres : "+autres;
    }
    return html.replace(/â€¢/g,"ğŸ”¹");
  }
  return "Aucun";
}

async function load(){
  let snap = await getDocs(query(collection(db,"fiches"), orderBy("date","desc")));
  let zone = document.getElementById("liste");

  snap.forEach(d=>{
    let f = d.data();
    let appareils = (f.appareils || []).map(a=>`â€¢ ${a.type} â€” ${a.marque} ${a.modele || ""}`).join("<br>");
    let sauv = (f.sauvegarde==="Oui") ? `Oui (${(f.sauvegardeItems||[]).join(", ")})` : "Non";
    let travaux = (f.travaux?.length) ? f.travaux.join("<br>") : "Aucun";
    let mdp = f.motdepasse && f.motdepasse.trim() ? f.motdepasse : "Non renseignÃ©";
    let accHTML = renderAccessoires(f);

    zone.innerHTML += `
<div class="fiche-card accordion-card">

  <div class="fiche-header">
    <div class="fiche-header-left">
      <span class="color-tag" style="background:${f.couleur || 'transparent'}"></span>
      <span class="fiche-name">${f.nom}</span>
    </div>
    <button class="delete-btn" onclick="supprimer('${d.id}')">ğŸ—‘</button>
  </div>

  <div class="fiche-content">
    <div class="fiche-date">ğŸ“… ${new Date(f.date).toLocaleDateString()}</div>

    <p>ğŸ“ ${formatTelAffichage(f.tel)}</p>
    <p>ğŸ’»<br>${(appareils || "").replace(/â€¢/g,"ğŸ”¹")}</p>
    <p>ğŸ’ Accessoires fournis :<br><strong>${accHTML}</strong></p>
    <p>ğŸ’¾ Sauvegarde : <strong>${sauv}</strong></p>
    <p>ğŸ” Mot de passe : <strong>${mdp}</strong></p>
    <p>ğŸ”§ Travaux :<br> <strong>${travaux}</strong></p>
    <p>ğŸ“ ${f.probleme || ""}</p>

    <!-- TARIFS -->
 <!-- TARIFS -->
<div class="tarifs-row">
  <span>ğŸ’°</span>
  <input class="tarif-input" type="text" id="est_${d.id}" value="${f.tarifEstimation || ""}">
  
  <span>âœ…</span>
  <input class="tarif-input" type="text" id="reel_${d.id}" value="${f.tarifReel || ""}">
  
  <button class="save-mini" onclick="saveTarifs('${d.id}')">ğŸ’¾</button>
</div>
  </div>

</div>`;
  });
}

window.supprimer = supprimer;
load();
</script>

<script>
document.addEventListener("click", function(e){
  let header = e.target.closest(".fiche-header");
  if(!header) return;
  header.parentNode.classList.toggle("open");
});
</script>

</head>

<body class="history-page">
<h1>ğŸ“š Historique des dÃ©pÃ´ts</h1>
<div id="liste" class="history-container"></div>
<div class="center"><a href="index.html" class="link return-link">â¬… Retour</a></div>
</body>
</html>